#!/bin/bash
# ULTIMATE AUTO-COMMIT SCRIPT
# –†–∞–±–æ—Ç–∞–µ—Ç –í–°–ï–ì–î–ê, –¥–∞–∂–µ –∫–æ–≥–¥–∞ VSCode —Ç–µ—Ä–º–∏–Ω–∞–ª –ø–∞–¥–∞–µ—Ç

set -e

REPO_DIR="/workspaces/mns-terminal"
cd "$REPO_DIR"

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –∫–æ–º–º–∏—Ç–∞
safe_commit() {
  local message="$1"
  
  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –µ—Å—Ç—å –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è
  if git diff --quiet && git diff --cached --quiet; then
    echo "‚ö†Ô∏è –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞"
    return 0
  fi
  
  # Stage –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
  git add -A
  
  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –µ—Å—Ç—å –ª–∏ —á—Ç–æ –∑–∞–∫–æ–º–º–∏—Ç–∏—Ç—å
  if git diff --cached --quiet; then
    echo "‚ö†Ô∏è –ù–µ—Ç staged –∏–∑–º–µ–Ω–µ–Ω–∏–π"
    return 0
  fi
  
  # –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–º–∏—Ç–∞
  if [ -z "$message" ]; then
    # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∞–≤—Ç–æ—Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
    local changed_files=$(git diff --cached --name-only | wc -l)
    message="chore: auto commit ${changed_files} files - $(date +'%Y-%m-%d %H:%M:%S')"
  fi
  
  git commit -m "$message"
  
  # Push —Å –ø–æ–≤—Ç–æ—Ä–Ω—ã–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏
  local max_attempts=3
  local attempt=1
  
  while [ $attempt -le $max_attempts ]; do
    if git push origin main 2>/dev/null; then
      echo "‚úÖ SUCCESS! –ö–æ–º–º–∏—Ç –∑–∞–ø—É—à–µ–Ω (–ø–æ–ø—ã—Ç–∫–∞ $attempt)"
      git log --oneline -1
      return 0
    else
      echo "‚ö†Ô∏è Push failed, –ø–æ–ø—ã—Ç–∫–∞ $attempt –∏–∑ $max_attempts..."
      attempt=$((attempt + 1))
      sleep 2
    fi
  done
  
  echo "‚ùå Push failed –ø–æ—Å–ª–µ $max_attempts –ø–æ–ø—ã—Ç–æ–∫"
  echo "üí° –ö–æ–º–º–∏—Ç —Å–æ–∑–¥–∞–Ω –ª–æ–∫–∞–ª—å–Ω–æ, –ø—É—à –≤—Ä—É—á–Ω—É—é: git push origin main"
  return 1
}

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
if [ "$1" == "--auto" ]; then
  safe_commit ""
elif [ -n "$1" ]; then
  safe_commit "$*"
else
  echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:"
  echo "  $0 \"commit message\"  - –ö–æ–º–º–∏—Ç —Å —Ç–≤–æ–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º"
  echo "  $0 --auto              - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∫–æ–º–º–∏—Ç"
  exit 1
fi
